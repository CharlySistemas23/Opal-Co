<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opal & Co - Sistema POS</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Topbar -->
    <header class="topbar">
        <div class="topbar-left">
            <div class="logo">
                <img src="assets/logo.png" alt="Opal & Co" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <span style="display:none; font-weight: 600; font-size: 18px;">OPAL & CO</span>
            </div>
            <div class="topbar-info">
                <span id="current-branch" class="branch-name">Tienda 1</span>
                <span class="separator">|</span>
                <span id="current-user" class="user-name">Usuario</span>
            </div>
        </div>
        <div class="topbar-center">
            <div class="search-global">
                <input type="text" id="global-search" placeholder="Buscar piezas, clientes, ventas...">
            </div>
        </div>
        <div class="topbar-right">
            <div class="sync-status" id="sync-status">
                <span class="status-indicator offline" id="connection-status"></span>
                <span id="sync-text">Offline</span>
            </div>
            <button class="btn-icon" id="sync-now-btn" title="Sincronizar ahora">
                <i class="fas fa-sync"></i>
            </button>
            <button class="btn-icon" id="logout-btn" title="Cerrar sesi√≥n">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-module="dashboard">
                    <span class="nav-icon"><i class="fas fa-chart-pie"></i></span>
                    <span class="nav-label">Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-module="pos">
                    <span class="nav-icon"><i class="fas fa-cash-register"></i></span>
                    <span class="nav-label">POS</span>
                </a>
                <a href="#" class="nav-item" data-module="inventory">
                    <span class="nav-icon"><i class="fas fa-box"></i></span>
                    <span class="nav-label">Inventario</span>
                </a>
                <a href="#" class="nav-item" data-module="customers">
                    <span class="nav-icon"><i class="fas fa-users"></i></span>
                    <span class="nav-label">Clientes</span>
                </a>
                <a href="#" class="nav-item" data-module="repairs">
                    <span class="nav-icon"><i class="fas fa-tools"></i></span>
                    <span class="nav-label">Reparaciones</span>
                </a>
                <a href="#" class="nav-item" data-module="employees">
                    <span class="nav-icon"><i class="fas fa-user-tie"></i></span>
                    <span class="nav-label">Empleados</span>
                </a>
                <a href="#" class="nav-item" data-module="reports">
                    <span class="nav-icon"><i class="fas fa-chart-bar"></i></span>
                    <span class="nav-label">Reportes</span>
                </a>
                <a href="#" class="nav-item" data-module="costs">
                    <span class="nav-icon"><i class="fas fa-dollar-sign"></i></span>
                    <span class="nav-label">Costos</span>
                </a>
                <a href="#" class="nav-item" data-module="tourist-report">
                    <span class="nav-icon"><i class="fas fa-suitcase"></i></span>
                    <span class="nav-label">Reporte Turistas</span>
                </a>
                <a href="#" class="nav-item" data-module="cash">
                    <span class="nav-icon"><i class="fas fa-cash-register"></i></span>
                    <span class="nav-label">Caja</span>
                </a>
                <a href="#" class="nav-item" data-module="barcodes">
                    <span class="nav-icon"><i class="fas fa-barcode"></i></span>
                    <span class="nav-label">C√≥digos de Barras</span>
                </a>
                <a href="#" class="nav-item" data-module="sync">
                    <span class="nav-icon"><i class="fas fa-sync"></i></span>
                    <span class="nav-label">Sincronizaci√≥n</span>
                </a>
                <a href="#" class="nav-item" data-module="settings">
                    <span class="nav-icon"><i class="fas fa-cog"></i></span>
                    <span class="nav-label">Configuraci√≥n</span>
                </a>
            </nav>
        </aside>

        <!-- Content Area -->
        <main class="content-area" id="content-area">
            <!-- Login Screen -->
            <div id="login-screen" class="login-screen">
                <div class="login-card">
                    <h1>Opal & Co</h1>
                    <p class="login-subtitle">Sistema POS</p>
                    <div class="login-form">
                        <div class="form-group">
                            <label>Usuario, nombre de empleado o c√≥digo de barras</label>
                            <input type="text" id="employee-barcode-input" class="form-input" placeholder="admin, Admin, EMP001..." autofocus>
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                Usuarios demo: <strong>admin</strong> o <strong>vendedor1</strong> | PIN: <strong>1234</strong>
                            </small>
                            <button type="button" id="create-demo-users-btn" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-user-plus"></i> Crear Usuarios Demo
                            </button>
                        </div>
                        <div class="form-group" id="pin-group">
                            <label>PIN</label>
                            <input type="password" id="pin-input" class="form-input" placeholder="Ingresa tu PIN (1234)" maxlength="6">
                        </div>
                        <div id="login-error" class="error-message" style="display: none;"></div>
                        <button class="btn-primary" id="login-btn" style="width: 100%; margin-top: 10px;">Iniciar Sesi√≥n</button>
                        <button class="btn-secondary" id="login-bypass-btn" style="width: 100%; margin-top: 8px; font-size: 11px; padding: 8px; background: #28a745; color: white; border: none; cursor: pointer;" onclick="setTimeout(() => { if(window.bypassLogin){window.bypassLogin();}else{alert('Espera 3 segundos y vuelve a intentar. El sistema se est√° cargando...');} }, 500);">üîì Acceso Directo (Click aqu√≠ si no puedes entrar)</button>
                        <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 4px; font-size: 12px;">
                            <strong>Acceso r√°pido:</strong><br>
                            Usuario: <strong>admin</strong><br>
                            PIN: <strong>1234</strong><br>
                            <small style="color: #d32f2f;">Si no funciona, usa "Acceso Directo"</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Module -->
            <div id="module-dashboard" class="module" style="display: none;">
                <div class="module-header">
                    <h2>Dashboard</h2>
                    <div class="module-actions">
                        <button class="btn-secondary" id="export-dashboard-btn">Exportar</button>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Ventas Hoy</div>
                        <div class="kpi-value" id="kpi-sales-today">$0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Tickets</div>
                        <div class="kpi-value" id="kpi-tickets">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Ticket Promedio</div>
                        <div class="kpi-value" id="kpi-avg-ticket">$0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">% Cierre</div>
                        <div class="kpi-value" id="kpi-close-rate">0%</div>
                    </div>
                </div>
                <div class="dashboard-section">
                    <h3>Top Vendedores</h3>
                    <div id="top-sellers-list" class="top-list"></div>
                </div>
                <div class="dashboard-section">
                    <h3>Alertas</h3>
                    <div id="alerts-list" class="alerts-list"></div>
                </div>
            </div>

            <!-- Barcodes Module -->
            <div id="module-barcodes" class="module" style="display: none;">
                <div id="barcodes-tabs" class="tabs-container" style="margin-bottom: var(--spacing-lg);">
                    <button class="tab-btn active" data-tab="overview"><i class="fas fa-chart-line"></i> Resumen</button>
                    <button class="tab-btn" data-tab="barcodes"><i class="fas fa-barcode"></i> C√≥digos</button>
                    <button class="tab-btn" data-tab="scan-history"><i class="fas fa-history"></i> Historial</button>
                    <button class="tab-btn" data-tab="templates"><i class="fas fa-file-alt"></i> Plantillas</button>
                    <button class="tab-btn" data-tab="settings"><i class="fas fa-cog"></i> Configuraci√≥n</button>
                </div>
                <div id="barcodes-content"></div>
            </div>

            <!-- POS Module -->
            <div id="module-pos" class="module" style="display: none;">
                <div class="module-header">
                    <h2>POS - Nueva Venta</h2>
                    <div class="module-actions">
                        <button class="btn-secondary" id="pos-history-btn">Historial</button>
                    </div>
                </div>
                <div class="pos-container-split">
                    <!-- Panel Izquierdo: Piezas Disponibles -->
                    <div class="pos-panel-left">
                        <div class="pos-panel-header">
                            <h3><i class="fas fa-shopping-bag"></i> Piezas Disponibles</h3>
                        </div>
                        <div class="pos-categories">
                            <button class="pos-category-btn" data-category="all">Todas</button>
                            <button class="pos-category-btn" data-category="anillos">Anillos</button>
                            <button class="pos-category-btn" data-category="collares">Collares</button>
                            <button class="pos-category-btn" data-category="aretes">Aretes</button>
                            <button class="pos-category-btn" data-category="pulseras">Pulseras</button>
                        </div>
                        <div class="pos-filters">
                            <select id="pos-category-filter" class="form-select">
                                <option value="">Todas las categor√≠as</option>
                                <option value="anillos">Anillos</option>
                                <option value="collares">Collares</option>
                                <option value="aretes">Aretes</option>
                                <option value="pulseras">Pulseras</option>
                            </select>
                            <input type="text" id="pos-product-search" class="form-input" placeholder="Buscar...">
                        </div>
                        <div class="pos-products-list" id="pos-products-list">
                            <div class="pos-empty-state">No se encontraron productos</div>
                        </div>
                    </div>
                    
                    <!-- Panel Derecho: Carrito -->
                    <div class="pos-panel-right">
                        <div class="pos-panel-header">
                            <h3><i class="fas fa-shopping-cart"></i> Carrito</h3>
                            <div class="pos-cart-header-actions">
                                <button class="pos-icon-btn" title="Acci√≥n">a</button>
                                <button class="pos-icon-btn" title="Carpeta"><i class="fas fa-folder"></i></button>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n de Gu√≠a y Agencia -->
                        <div class="pos-info-bar-compact">
                            <div class="pos-info-item">
                                <label>GU√çA</label>
                                <div id="pos-current-guide">-</div>
                            </div>
                            <div class="pos-info-item">
                                <label>AGENCIA</label>
                                <div id="pos-current-agency">-</div>
                            </div>
                            <button class="btn-secondary btn-sm" onclick="window.POS.clearGuide()">Limpiar</button>
                        </div>
                        
                        <!-- Descuento R√°pido -->
                        <div class="pos-quick-discount">
                            <label>Descuento R√°pido</label>
                            <div class="pos-discount-buttons">
                                <button class="pos-discount-btn" onclick="window.POS.applyQuickDiscount(5)">5%</button>
                                <button class="pos-discount-btn" onclick="window.POS.applyQuickDiscount(10)">10%</button>
                                <button class="pos-discount-btn" onclick="window.POS.applyQuickDiscount(15)">15%</button>
                                <button class="pos-discount-btn" onclick="window.POS.applyQuickDiscount(20)">20%</button>
                                <button class="pos-discount-btn pos-discount-remove" onclick="window.POS.removeDiscount()">Quitar</button>
                            </div>
                        </div>
                        
                        <!-- Items del Carrito -->
                        <div class="pos-cart-items" id="pos-cart-items">
                            <div class="pos-empty-cart">El carrito est√° vac√≠o</div>
                        </div>
                        
                        <!-- Total -->
                        <div class="pos-cart-total">
                            <span>Total:</span>
                            <span id="pos-total">$0.00</span>
                        </div>
                        
                        <!-- Bot√≥n Procesar Venta -->
                        <button class="btn-primary btn-process-sale" id="pos-complete-btn">
                            ‚úì Procesar Venta
                        </button>
                        
                        <!-- Secci√≥n de Pagos (colapsable) -->
                        <div class="pos-payments-collapsed" id="pos-payments-section">
                            <div class="pos-payments-header" onclick="window.POS.togglePayments()">
                                <span>Pagos</span>
                                <span id="pos-payments-toggle">‚ñº</span>
                            </div>
                            <div class="pos-payments-content" id="pos-payments-content" style="display: none;">
                                <div class="payments-grid">
                                    <div class="form-group">
                                        <label>Efectivo USD</label>
                                        <input type="number" id="payment-cash-usd" class="form-input" step="0.01" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Efectivo MXN</label>
                                        <input type="number" id="payment-cash-mxn" class="form-input" step="0.01" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Efectivo CAD</label>
                                        <input type="number" id="payment-cash-cad" class="form-input" step="0.01" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label>TPV Visa/MC</label>
                                        <input type="number" id="payment-tpv-visa" class="form-input" step="0.01" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label>TPV Amex</label>
                                        <input type="number" id="payment-tpv-amex" class="form-input" step="0.01" value="0">
                                    </div>
                                </div>
                                <div class="payments-total">
                                    <div class="total-row">
                                        <span>Total Pagos:</span>
                                        <span id="payments-total">$0.00</span>
                                    </div>
                                    <div class="total-row" id="payments-difference-row">
                                        <span>Diferencia:</span>
                                        <span id="payments-difference">$0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Module -->
            <div id="module-inventory" class="module" style="display: none;">
                <div class="module-header">
                    <h2>Inventario</h2>
                    <div class="module-actions">
                        <button class="btn-primary" id="inventory-add-btn">Nueva Pieza</button>
                        <button class="btn-secondary" id="inventory-import-btn">Importar CSV</button>
                        <button class="btn-secondary" id="inventory-export-btn">Exportar</button>
                    </div>
                </div>
                <div class="inventory-filters" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; padding: 20px; background: var(--color-bg-secondary); border-radius: var(--radius-lg); margin-bottom: 24px;">
                    <div class="form-group">
                        <label>B√∫squeda</label>
                        <input type="text" id="inventory-search" class="form-input" placeholder="SKU, nombre, barcode, metal...">
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="inventory-status-filter" class="form-select">
                            <option value="">Todos los estados</option>
                            <option value="disponible">Disponible</option>
                            <option value="vendida">Vendida</option>
                            <option value="apartada">Apartada</option>
                            <option value="reparacion">En Reparaci√≥n</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sucursal</label>
                        <select id="inventory-branch-filter" class="form-select">
                            <option value="">Todas las sucursales</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Metal</label>
                        <select id="inventory-metal-filter" class="form-select">
                            <option value="">Todos los metales</option>
                            <option value="Oro 18k">Oro 18k</option>
                            <option value="Oro 14k">Oro 14k</option>
                            <option value="Oro 10k">Oro 10k</option>
                            <option value="Plata 925">Plata 925</option>
                            <option value="Plata Sterling">Plata Sterling</option>
                            <option value="Platino">Platino</option>
                            <option value="Paladio">Paladio</option>
                            <option value="Titanio">Titanio</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Piedra</label>
                        <select id="inventory-stone-type-filter" class="form-select">
                            <option value="">Todas las piedras</option>
                            <option value="Diamante">Diamante</option>
                            <option value="Rub√≠">Rub√≠</option>
                            <option value="Zafiro">Zafiro</option>
                            <option value="Esmeralda">Esmeralda</option>
                            <option value="Perla">Perla</option>
                            <option value="Amatista">Amatista</option>
                            <option value="Topacio">Topacio</option>
                            <option value="Citrino">Citrino</option>
                            <option value="Aguamarina">Aguamarina</option>
                            <option value="Tanzanita">Tanzanita</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Con Certificado</label>
                        <select id="inventory-certificate-filter" class="form-select">
                            <option value="">Todos</option>
                            <option value="yes">Con Certificado</option>
                            <option value="no">Sin Certificado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Precio M√≠nimo</label>
                        <input type="number" id="inventory-min-price" class="form-input" step="0.01" value="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Precio M√°ximo</label>
                        <input type="number" id="inventory-max-price" class="form-input" step="0.01" value="999999999" placeholder="Sin l√≠mite">
                    </div>
                </div>
                <div id="inventory-list" class="inventory-grid"></div>
            </div>

            <!-- Other modules will be loaded dynamically -->
            <div id="module-placeholder" class="module" style="display: none;">
                <div class="module-header">
                    <h2 id="module-title">M√≥dulo</h2>
                </div>
                <div id="module-content"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal" id="modal-container">
            <div class="modal-header">
                <h3 id="modal-title"></h3>
                <button class="modal-close" id="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer"></div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Librer√≠as externas - Deben cargarse primero -->
    <script src="libs/jspdf.umd.min.js"></script>
    <script src="libs/xlsx.full.min.js"></script>
    <script src="libs/JsBarcode.all.min.js"></script>
    
    <!-- Verificaci√≥n de librer√≠as -->
    <script>
        // Verificar que las librer√≠as se hayan cargado correctamente
        window.addEventListener('DOMContentLoaded', function() {
            if (typeof window.jspdf === 'undefined') {
                console.error('‚ö†Ô∏è jsPDF no se carg√≥ correctamente. Verifica que el archivo libs/jspdf.umd.min.js exista.');
            } else {
                console.log('‚úÖ jsPDF cargado correctamente');
            }
            
            if (typeof XLSX === 'undefined') {
                console.error('‚ö†Ô∏è SheetJS (XLSX) no se carg√≥ correctamente. Verifica que el archivo libs/xlsx.full.min.js exista.');
            } else {
                console.log('‚úÖ SheetJS (XLSX) cargado correctamente');
            }
            
            if (typeof JsBarcode === 'undefined') {
                console.error('‚ö†Ô∏è JsBarcode no se carg√≥ correctamente. Verifica que el archivo libs/JsBarcode.all.min.js exista.');
            } else {
                console.log('‚úÖ JsBarcode cargado correctamente');
            }
        });
    </script>
    
    <script src="js/utils.js"></script>
    <script src="js/db.js"></script>
    <script src="js/backup.js"></script>
    <script src="js/barcodes.js"></script>
    <script src="js/sync.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/inventory.js"></script>
    <script src="js/users.js"></script>
    <script src="js/pos.js"></script>
    <script src="js/customers.js"></script>
    <script src="js/employees.js"></script>
    <script src="js/repairs.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/reports.js"></script>
    <script src="js/costs.js"></script>
    <script src="js/tourist_report.js"></script>
    <script src="js/cash.js"></script>
    <script src="js/barcodes_module.js"></script>
    <script src="js/settings.js"></script>
    <script src="js/sync_ui.js"></script>
    <script src="js/printer.js"></script>
    <script src="js/app.js"></script>
</body>
</html>

